# Dimension Reduction {#sec-reduce-dim}

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
  echo    = FALSE, 
  error   = FALSE, 
  message = FALSE, 
  warning = FALSE
)
```

```{r}
#| label: CRAN-libraries

library(assertthat)
library(beans)
library(Cairo)
# library(cairoDevice)
library(corrplot)
# library(dslabs)
library(GGally)
# library(ggimg)
# library(HistData)
library(here)
library(ISLR)
# library(keras)
library(knitr)
# library(latex2exp)
# library(OECD)
# library(patchwork)
library(plotly)
# library(regclass)
# library(rgl)
# library(R.utils)
# library(reticulate)
# library(scatterplot3d)
# library(tensorflow)
library(tidymodels)
library(tidyverse)
# library(tinytex)
# library(UsingR)
```

```{r}
#| label: local-source

# source(here("code", "galton_ht_data.R"))
# source(here("code", "mnist_file_mgmt.R"))
# source(here("code", "oecd_bli.R"))
# source(here("code", "pgram_grid.R"))
source(here("code", "vc_per_state.R"))
source(here("code", "wine_quality_uci.R"))
# source(here("code", "z_score.R"))
```

This chapter addresses the problem of finding and visualizing structure in high-dimensional data.  We begin the discussion with example data sets.

## Data Examples

### US Arrests

```{r}
#| label: stats-per-us-state-1970s

state_stats_lst <- list_state_stats()

# (x, y) = (lat, long)
st_ctr_tbl <- 
  state_stats_lst$ st_ctr_tbl

# 8 state stats: Population, ..., Area
st_77_tbl <- 
  state_stats_lst$ st_77_tbl

# UrbanPop + 3 violent crimes: Assault, Murder, Rape
arrests_wide <- 
  state_stats_lst$ arrests_wide
arrests_long <- 
  state_stats_lst$ arrests_long

# compilation of the above
st_wide <- 
  state_stats_lst$ st_wide
st_wide_dscr <- 
  state_stats_lst$ st_wide_dscr
```

Data analysis often begins with an exploration, using tables and figures to learn more about the data before formulating specific questions or hypotheses.  The exploration becomes more difficult as the dimensions of the data set increase.  Here's an example.

@McNeil_1977 reviewed the relationship among violent crime statistics per US state and the percent of the population living in urban areas, variables described in @tbl-arrests-per-us-state-1973 below.  With just four variables, we can visualize the full data structure (e.g., using a scatter plot matrix as shown in @fig-arrests-2d-scatter-matrix).  However, the initial exploratory data analysis reveals strong correlations among the three crime variables (Murder, Assault, Rape), suggesting that the data may effectively lie in fewer than four dimensions.  Dimension reduction techniques can help us identify these underlying patterns, enabling us to (1) visualize state-level crime patterns in 2D or 3D, (2) identify states having similar crime profiles, and (3) understand whether crime variation is driven by one dominant factor or multiple independent factors.

@tbl-stats-per-us-state-1970s below describes related state-level statistics from the same period (the 1970s).  The data from both tables are available from the core `R` package `datasets`.

```{r}
#| label: tbl-arrests-per-us-state-1973

st_wide_dscr |> 
  dplyr::filter(
    var %in% c("Assault", "Rape", "Murder", "UrbanPop")
  ) |> 
  dplyr::rename(variable = var, description = dscr) |> 
  knitr::kable(
    caption = "Arrests per US State (1973)")

```

```{r}
#| label: tbl-stats-per-us-state-1970s

st_wide_dscr |> 
  dplyr::filter(
    ! (var %in% c("Assault", "Rape", "Murder", "UrbanPop"))
  ) |> 
  dplyr::rename(variable = var, description = dscr) |> 
  knitr::kable(
    caption = "Statistics per US State (1970s)")
```

@fig-arrests-violin below shows the distribution across the 50 states of each type of violent crime.  Rates are calcuated as arrests per 100,000 population.  The figure shows these rates on a $\log_{10}$ scale, since assault arrests are many times more common than rape or murder arrests.

```{r}
#| label: fig-arrests-violin
#| fig-cap: "Violent Crime Rates per US State (1973)"

g_arrests_violin <- arrests_long |> 
  dplyr::filter(var != "UrbanPop") |> 
  dplyr::mutate(var = forcats::as_factor(var)) |> 
  ggplot2::ggplot(mapping = aes(
    x = var, y = rate, color = var, fill = var
  )) + 
  geom_violin(show.legend = FALSE) + 
  scale_y_log10() + 
  labs(
    title = "Violent Crime Rates per US State (1973)", 
    subtitle = "arrests per 100K population"
  )

g_arrests_violin

```

The figure above gives a view of three data variables, that is, three columns of the data matrix.  @fig-arrests-3d-scatter below, a 3D scatterplot, gives a complementary view of each of the 50 states as a point whose coordinates are the respective arrest rates for assault, rape, and murder, with each point colored by the value of `UrbanPop` the percentage of the state's population living in an urban area.  Since individual states correspond to the rows of the data matrix, this figure is a row-based perspective on the data matrix.

```{r}
#| label: fig-arrests-3d-scatter
#| fig-cap: "Violent Crime Rates in each US State (1973)"

g_arrests_3d_scatter <- arrests_wide |> 
  plot_ly(
    x = ~Assault, 
    y = ~Rape, 
    z = ~Murder,
    type = "scatter3d",
    mode = "markers",
    text = ~arrests_wide$ st_abb,  # State abbreviation for hover
    marker = list(
      size = 5,
      color = ~UrbanPop,  # Optional: color by UrbanPop
      colorscale = "Viridis",
      showscale = TRUE,
      colorbar = list(title = "UrbanPop"))) |> 
  layout(scene = list(
    xaxis = list(title = "Assault"),
    yaxis = list(title = "Rape"),
    zaxis = list(title = "Murder")
  ),
  title = "Violent Crime Rates in each US State (1973)")

g_arrests_3d_scatter

```

@fig-arrests-2d-scatter-matrix below exemplifies a matrix of 2D scatter plots, a display method that accommodates more than 3 variables (but not many more, practically speaking). 

```{r}
#| label: fig-arrests-2d-scatter-matrix
#| fig-cap: "Arrests Variables: Relationships and Correlations"

g_arrests_2d_scatter_matrix <- arrests_wide |> 
  GGally::ggpairs(
    columns = c("Assault", "Rape", "Murder", "UrbanPop"),
    upper = list(continuous = wrap("cor", size = 3)),
    lower = list(continuous = wrap("points", alpha = 0.5, size = 0.8)),
    title = "Arrests Variables: Relationships and Correlations")

g_arrests_2d_scatter_matrix

```

This figure provides both column-based and row-based views of the data matrix, with the scatter diagrams for each pair of variables providing the row-based perspective.

### Dry Beans

@Koklu_Ozkan_2020_multiclass published a data set of visual characteristics of dried beans ... 

  > ... in order to obtain uniform seed classification. For the classification model, images of 13,611 grains of 7 different registered dry beans were taken with a high-resolution camera.

The data are available `R` package `beans`, containing a data matrix (tibble, more precisely) of dimension $13611 \times 17$.  The last column of the data matrix is response variable `class` that assigns one of seven types of bean to each bean-image.  The remaining 16 columns of the data matrix are morphological measurements (of shape and size).

@Kuhn_Silge_tmwr develop and evaluate different classification models for these data. [^beans-ttv-split]  They begin by examining the correlation coefficients for each pair of the 16 feature vectors.  @fig-beans-corrplot follows their example.

[^beans-ttv-split]: To develop and evaluate the classification models, the authors split the observations into three non-overlapping sets: training ($n = 10206$, nearly 75%), testing $(n = 1703)$, and validation $(n = 1702)$.

```{r}
#| label: beans-tbl

beans_tbl <- beans::beans

```

```{r}
#| label: fig-beans-corrplot
#| fig-cap: "beans: correlation among features"

# from tmwr:
# tmwr_cols <- grDevices::colorRampPalette(c("#91CBD765", "#CA225E"))
# col = tmwr_cols(200)

b_corr_colors <- grDevices::colorRampPalette(c("blue", "red"))

beans_corr_lst <- beans_tbl |> 
  dplyr::select(-class) |> 
  cor() |> 
  corrplot::corrplot(
    method        = "ellipse", 
    type          = "lower", 
    diag          = FALSE, 
    # order         = "hclust", 
    # hclust.method = "complete", 
    col           = b_corr_colors(200), 
    tl.col        = "black"
  )

# from vignette("corrplot-intro"): 
# (method = 'square', order = 'FPC', type = 'lower', diag = FALSE)

```

In this figure, the absolute value of each correlation coefficient is represented by the narrowness of the drawn ellipse and the depth of its color.  The sign of the correlation coefficient is represented by both the color and direction of the ellipse.

These size and shape features measure similar concepts. Consequently, several pairs of feature vectors are highly correlated, [^beans-correlation-xmpl] which offers the possibility of transforming the 16 original features into a smaller set without sacrificing classification power.

[^beans-correlation-xmpl]: For example, the features `area` and `convex_area` can differ in principle, but for the beans data the correlation is `r beans_corr_lst$corr[["convex_area", "area"]] |> round(digits = 5)`.

### Wine Quality

```{r}
#| label: get-wine-quality

wine_quality <- get_wine_quality()

# lubridate::now()
# [1] "2025-11-04 12:46:12 GMT"

# wine_quality |> str()
# spc_tbl_ [6,497 Ã— 13] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
#  $ fixed acidity       : num [1:6497] 7.4 7.8 7.8 11.2 7.4 7.4 7.9 7.3 7.8 7.5 ...
#  $ volatile acidity    : num [1:6497] 0.7 0.88 0.76 0.28 0.7 0.66 0.6 0.65 0.58 0.5 ...
#  $ citric acid         : num [1:6497] 0 0 0.04 0.56 0 0 0.06 0 0.02 0.36 ...
#  $ residual sugar      : num [1:6497] 1.9 2.6 2.3 1.9 1.9 1.8 1.6 1.2 2 6.1 ...
#  $ chlorides           : num [1:6497] 0.076 0.098 0.092 0.075 0.076 0.075 0.069 0.065 0.073 0.071 ...
#  $ free sulfur dioxide : num [1:6497] 11 25 15 17 11 13 15 15 9 17 ...
#  $ total sulfur dioxide: num [1:6497] 34 67 54 60 34 40 59 21 18 102 ...
#  $ density             : num [1:6497] 0.998 0.997 0.997 0.998 0.998 ...
#  $ pH                  : num [1:6497] 3.51 3.2 3.26 3.16 3.51 3.51 3.3 3.39 3.36 3.35 ...
#  $ sulphates           : num [1:6497] 0.56 0.68 0.65 0.58 0.56 0.56 0.46 0.47 0.57 0.8 ...
#  $ alcohol             : num [1:6497] 9.4 9.8 9.8 9.8 9.4 9.4 9.4 10 9.5 10.5 ...
#  $ quality             : num [1:6497] 5 5 5 6 5 5 5 7 7 5 ...
#  $ color               : chr [1:6497] "red" "red" "red" "red" ...
#  - attr(*, "spec")=
#   .. cols(
#   ..   `fixed acidity` = col_double(),
#   ..   `volatile acidity` = col_double(),
#   ..   `citric acid` = col_double(),
#   ..   `residual sugar` = col_double(),
#   ..   chlorides = col_double(),
#   ..   `free sulfur dioxide` = col_double(),
#   ..   `total sulfur dioxide` = col_double(),
#   ..   density = col_double(),
#   ..   pH = col_double(),
#   ..   sulphates = col_double(),
#   ..   alcohol = col_double(),
#   ..   quality = col_double()
#   .. )
#  - attr(*, "problems")=<externalptr>
```

```{r}
#| label: wq-dimensions

# capture dimensions to embed in narrative
wq_nrow <- nrow(wine_quality)
wq_ncol <- ncol(wine_quality)
wq_n_red <- wine_quality |> 
  dplyr::filter(color == "red") |> nrow()
wq_n_white <- wine_quality |> 
  dplyr::filter(color == "white") |> nrow()
```

@Cortez_2009_ModelingWP model wine preference as a function of `r wq_ncol - 1L` physicochemical properties of wine, which are listed in @tbl-wq-var-dscr.  The `quality` score is the median of three expert tastings.  The data consist of `r wq_nrow` wines, `r wq_n_red` red and `r wq_n_white` white. [^wq-uci-repo] [^red-v-white-wine]

[^wq-uci-repo]: The authors contributed the data (now archived) to the UC Irvine Machine Learning Repository.  See @wine_quality_186.

[^red-v-white-wine]: The wines in this study are all from the Minho (northwest) region of Portugal.  Medium in alcohol, it is appreciated for its freshness (especially in summer). At the time of writing the authors report that Minho wine accounts for 15% of total Portuguese wine production, of which some 10% is exported, mostly white wine.

```{r}
#| label: tbl-wq-var-dscr

wq_var_dscr <- describe_wq_vars()

wq_var_dscr |> 
  dplyr::rename(variable = var) |> 
  knitr::kable(
    caption = "Wine: physicochemical properties")
```

Correlations among the `r wq_ncol - 2L` numeric features are shown in @fig-rw-wq-corrplot below for red and white wines, respectively.

```{r}
#| label: fig-rw-wq-corrplot
#| fig-cap: "Wine: correlation among numeric features"
#| fig-subcap: 
#|   - "Red wines"
#|   - "White wines"
#| layout-ncol: 2

wq_corr_colors <- grDevices::colorRampPalette(c("blue", "red"))

red_wq_corr_lst <- wine_quality |> 
  dplyr::filter(color == "red") |> 
  dplyr::select(-c(quality, color)) |> 
  cor() |> 
  corrplot::corrplot(
    method        = "ellipse", 
    type          = "lower", 
    diag          = FALSE, 
    col           = wq_corr_colors(200), 
    tl.col        = "black"
  )

white_wq_corr_lst <- wine_quality |> 
  dplyr::filter(color == "white") |> 
  dplyr::select(-c(quality, color)) |> 
  cor() |> 
  corrplot::corrplot(
    method        = "ellipse", 
    type          = "lower", 
    diag          = FALSE, 
    col           = wq_corr_colors(200), 
    tl.col        = "black"
  )

```

These figures reveal some substantial correlations, with distinct patterns per wine color.

@tbl-rw-quality-corr below shows feature-quality correlations for red and white wines, respectively.

```{r}
#| label: rw-quality-corr-tbl

rw_quality_corr_tbl <- wine_quality |> 
  get_rw_quality_corr_tbl()

```

```{r}
#| label: tbl-rw-quality-corr
#| tbl-cap: "Feature-quality correleations among (red, white) wines"

rw_quality_corr_tbl |> 
  knitr::kable(
    caption = "Feature-quality correleations", 
    digits = 2
  )

```

We see that alcohol volume is a prominent indicator of quality for both red and white wines.  On the other hand, citric acid and sulphates are strongly correlated with the quality of red wine, but not white.

As demonstrated by @Cortez_2009_ModelingWP, these data patterns offer the possibility of developing a smaller set of features as predictors of wine quality.

### Cancer Genomics (NCI 60)


